commit a8bfc40cf28992b15a4aefb68ed693b63ac3e5d3
Author: zanac1986 <zanhsieh@protonmail.com>
Date:   Sun Nov 13 08:50:40 2022 +0800

    [grafana] Major refactor
    
    Signed-off-by: zanac1986 <zanhsieh@protonmail.com>

diff --git a/charts/grafana/templates/NOTES.txt b/charts/grafana/templates/NOTES.txt
index 1fc8436d..fa2c4fe6 100644
--- a/charts/grafana/templates/NOTES.txt
+++ b/charts/grafana/templates/NOTES.txt
@@ -24,24 +24,24 @@
    Or grafana would always crash.
 
    From outside the cluster, the server URL(s) are:
-{{- range .Values.ingress.hosts }}
+     {{- range .Values.ingress.hosts }}
      http://{{ . }}
-{{- end }}
-{{ else }}
+     {{- end }}
+{{- else }}
    Get the Grafana URL to visit by running these commands in the same shell:
-{{ if contains "NodePort" .Values.service.type -}}
+   {{- if contains "NodePort" .Values.service.type }}
      export NODE_PORT=$(kubectl get --namespace {{ template "grafana.namespace" . }} -o jsonpath="{.spec.ports[0].nodePort}" services {{ template "grafana.fullname" . }})
      export NODE_IP=$(kubectl get nodes --namespace {{ template "grafana.namespace" . }} -o jsonpath="{.items[0].status.addresses[0].address}")
      echo http://$NODE_IP:$NODE_PORT
-{{ else if contains "LoadBalancer" .Values.service.type -}}
+   {{- else if contains "LoadBalancer" .Values.service.type }}
    NOTE: It may take a few minutes for the LoadBalancer IP to be available.
         You can watch the status of by running 'kubectl get svc --namespace {{ template "grafana.namespace" . }} -w {{ template "grafana.fullname" . }}'
      export SERVICE_IP=$(kubectl get svc --namespace {{ template "grafana.namespace" . }} {{ template "grafana.fullname" . }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
      http://$SERVICE_IP:{{ .Values.service.port -}}
-{{ else if contains "ClusterIP"  .Values.service.type }}
+   {{- else if contains "ClusterIP"  .Values.service.type }}
      export POD_NAME=$(kubectl get pods --namespace {{ template "grafana.namespace" . }} -l "app.kubernetes.io/name={{ template "grafana.name" . }},app.kubernetes.io/instance={{ .Release.Name }}" -o jsonpath="{.items[0].metadata.name}")
      kubectl --namespace {{ template "grafana.namespace" . }} port-forward $POD_NAME 3000
-{{- end }}
+   {{- end }}
 {{- end }}
 
 3. Login with the password from step 1 and the username: {{ .Values.adminUser }}
diff --git a/charts/grafana/templates/_helpers.tpl b/charts/grafana/templates/_helpers.tpl
index 369e69fa..4ba76755 100644
--- a/charts/grafana/templates/_helpers.tpl
+++ b/charts/grafana/templates/_helpers.tpl
@@ -3,8 +3,8 @@
 Expand the name of the chart.
 */}}
 {{- define "grafana.name" -}}
-{{- default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix "-" -}}
-{{- end -}}
+{{- default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix "-" }}
+{{- end }}
 
 {{/*
 Create a default fully qualified app name.
@@ -12,54 +12,54 @@ We truncate at 63 chars because some Kubernetes name fields are limited to this
 If release name contains chart name it will be used as a full name.
 */}}
 {{- define "grafana.fullname" -}}
-{{- if .Values.fullnameOverride -}}
-{{- .Values.fullnameOverride | trunc 63 | trimSuffix "-" -}}
-{{- else -}}
-{{- $name := default .Chart.Name .Values.nameOverride -}}
-{{- if contains $name .Release.Name -}}
-{{- .Release.Name | trunc 63 | trimSuffix "-" -}}
-{{- else -}}
-{{- printf "%s-%s" .Release.Name $name | trunc 63 | trimSuffix "-" -}}
-{{- end -}}
-{{- end -}}
-{{- end -}}
+{{- if .Values.fullnameOverride }}
+{{- .Values.fullnameOverride | trunc 63 | trimSuffix "-" }}
+{{- else }}
+{{- $name := default .Chart.Name .Values.nameOverride }}
+{{- if contains $name .Release.Name }}
+{{- .Release.Name | trunc 63 | trimSuffix "-" }}
+{{- else }}
+{{- printf "%s-%s" .Release.Name $name | trunc 63 | trimSuffix "-" }}
+{{- end }}
+{{- end }}
+{{- end }}
 
 {{/*
 Create chart name and version as used by the chart label.
 */}}
 {{- define "grafana.chart" -}}
-{{- printf "%s-%s" .Chart.Name .Chart.Version | replace "+" "_" | trunc 63 | trimSuffix "-" -}}
-{{- end -}}
+{{- printf "%s-%s" .Chart.Name .Chart.Version | replace "+" "_" | trunc 63 | trimSuffix "-" }}
+{{- end }}
 
 {{/*
 Create the name of the service account
 */}}
 {{- define "grafana.serviceAccountName" -}}
-{{- if .Values.serviceAccount.create -}}
-    {{ default (include "grafana.fullname" .) .Values.serviceAccount.name }}
-{{- else -}}
-    {{ default "default" .Values.serviceAccount.name }}
-{{- end -}}
-{{- end -}}
+{{- if .Values.serviceAccount.create }}
+{{- default (include "grafana.fullname" .) .Values.serviceAccount.name }}
+{{- else }}
+{{- default "default" .Values.serviceAccount.name }}
+{{- end }}
+{{- end }}
 
 {{- define "grafana.serviceAccountNameTest" -}}
-{{- if .Values.serviceAccount.create -}}
-    {{ default (print (include "grafana.fullname" .) "-test") .Values.serviceAccount.nameTest }}
-{{- else -}}
-    {{ default "default" .Values.serviceAccount.nameTest }}
-{{- end -}}
-{{- end -}}
+{{- if .Values.serviceAccount.create }}
+{{- default (print (include "grafana.fullname" .) "-test") .Values.serviceAccount.nameTest }}
+{{- else }}
+{{- default "default" .Values.serviceAccount.nameTest }}
+{{- end }}
+{{- end }}
 
 {{/*
 Allow the release namespace to be overridden for multi-namespace deployments in combined charts
 */}}
 {{- define "grafana.namespace" -}}
-  {{- if .Values.namespaceOverride -}}
-    {{- .Values.namespaceOverride -}}
-  {{- else -}}
-    {{- .Release.Namespace -}}
-  {{- end -}}
-{{- end -}}
+{{- if .Values.namespaceOverride }}
+{{- .Values.namespaceOverride }}
+{{- else }}
+{{- .Release.Namespace }}
+{{- end }}
+{{- end }}
 
 {{/*
 Common labels
@@ -71,10 +71,10 @@ helm.sh/chart: {{ include "grafana.chart" . }}
 app.kubernetes.io/version: {{ .Values.image.tag | default .Chart.AppVersion | quote }}
 {{- end }}
 app.kubernetes.io/managed-by: {{ .Release.Service }}
-{{- if .Values.extraLabels }}
-{{ toYaml .Values.extraLabels }}
+{{- with .Values.extraLabels }}
+{{- toYaml . }}
+{{- end }}
 {{- end }}
-{{- end -}}
 
 {{/*
 Selector labels
@@ -82,7 +82,7 @@ Selector labels
 {{- define "grafana.selectorLabels" -}}
 app.kubernetes.io/name: {{ include "grafana.name" . }}
 app.kubernetes.io/instance: {{ .Release.Name }}
-{{- end -}}
+{{- end }}
 
 {{/*
 Common labels
@@ -94,7 +94,7 @@ helm.sh/chart: {{ include "grafana.chart" . }}
 app.kubernetes.io/version: {{ .Values.image.tag | default .Chart.AppVersion | quote }}
 {{- end }}
 app.kubernetes.io/managed-by: {{ .Release.Service }}
-{{- end -}}
+{{- end }}
 
 {{/*
 Selector labels ImageRenderer
@@ -102,73 +102,73 @@ Selector labels ImageRenderer
 {{- define "grafana.imageRenderer.selectorLabels" -}}
 app.kubernetes.io/name: {{ include "grafana.name" . }}-image-renderer
 app.kubernetes.io/instance: {{ .Release.Name }}
-{{- end -}}
+{{- end }}
 
 {{/*
 Looks if there's an existing secret and reuse its password. If not it generates
 new password and use it.
 */}}
 {{- define "grafana.password" -}}
-{{- $secret := (lookup "v1" "Secret" (include "grafana.namespace" .) (include "grafana.fullname" .) ) -}}
-  {{- if $secret -}}
-    {{-  index $secret "data" "admin-password" -}}
-  {{- else -}}
-    {{- (randAlphaNum 40) | b64enc | quote -}}
-  {{- end -}}
-{{- end -}}
+{{- $secret := (lookup "v1" "Secret" (include "grafana.namespace" .) (include "grafana.fullname" .) ) }}
+{{- if $secret }}
+{{- index $secret "data" "admin-password" }}
+{{- else }}
+{{- (randAlphaNum 40) | b64enc | quote }}
+{{- end }}
+{{- end }}
 
 {{/*
 Return the appropriate apiVersion for rbac.
 */}}
 {{- define "grafana.rbac.apiVersion" -}}
-  {{- if .Capabilities.APIVersions.Has "rbac.authorization.k8s.io/v1" }}
-    {{- print "rbac.authorization.k8s.io/v1" -}}
-  {{- else -}}
-    {{- print "rbac.authorization.k8s.io/v1beta1" -}}
-  {{- end -}}
-{{- end -}}
+{{- if .Capabilities.APIVersions.Has "rbac.authorization.k8s.io/v1" }}
+{{- print "rbac.authorization.k8s.io/v1" }}
+{{- else }}
+{{- print "rbac.authorization.k8s.io/v1beta1" }}
+{{- end }}
+{{- end }}
 
 {{/*
 Return the appropriate apiVersion for ingress.
 */}}
 {{- define "grafana.ingress.apiVersion" -}}
-  {{- if and (.Capabilities.APIVersions.Has "networking.k8s.io/v1") (semverCompare ">= 1.19-0" .Capabilities.KubeVersion.Version) -}}
-      {{- print "networking.k8s.io/v1" -}}
-  {{- else if .Capabilities.APIVersions.Has "networking.k8s.io/v1beta1" -}}
-    {{- print "networking.k8s.io/v1beta1" -}}
-  {{- else -}}
-    {{- print "extensions/v1beta1" -}}
-  {{- end -}}
-{{- end -}}
+{{- if and (.Capabilities.APIVersions.Has "networking.k8s.io/v1") (semverCompare ">= 1.19-0" .Capabilities.KubeVersion.Version) }}
+{{- print "networking.k8s.io/v1" }}
+{{- else if .Capabilities.APIVersions.Has "networking.k8s.io/v1beta1" }}
+{{- print "networking.k8s.io/v1beta1" }}
+{{- else }}
+{{- print "extensions/v1beta1" }}
+{{- end }}
+{{- end }}
 
 {{/*
 Return the appropriate apiVersion for podDisruptionBudget.
 */}}
 {{- define "grafana.podDisruptionBudget.apiVersion" -}}
-  {{- if $.Capabilities.APIVersions.Has "policy/v1/PodDisruptionBudget" -}}
-    {{- print "policy/v1" -}}
-  {{- else -}}
-    {{- print "policy/v1beta1" -}}
-  {{- end -}}
-{{- end -}}
+{{- if $.Capabilities.APIVersions.Has "policy/v1/PodDisruptionBudget" }}
+{{- print "policy/v1" }}
+{{- else }}
+{{- print "policy/v1beta1" }}
+{{- end }}
+{{- end }}
 
 {{/*
 Return if ingress is stable.
 */}}
 {{- define "grafana.ingress.isStable" -}}
-  {{- eq (include "grafana.ingress.apiVersion" .) "networking.k8s.io/v1" -}}
-{{- end -}}
+{{- eq (include "grafana.ingress.apiVersion" .) "networking.k8s.io/v1" }}
+{{- end }}
 
 {{/*
 Return if ingress supports ingressClassName.
 */}}
 {{- define "grafana.ingress.supportsIngressClassName" -}}
-  {{- or (eq (include "grafana.ingress.isStable" .) "true") (and (eq (include "grafana.ingress.apiVersion" .) "networking.k8s.io/v1beta1") (semverCompare ">= 1.18-0" .Capabilities.KubeVersion.Version)) -}}
-{{- end -}}
+{{- or (eq (include "grafana.ingress.isStable" .) "true") (and (eq (include "grafana.ingress.apiVersion" .) "networking.k8s.io/v1beta1") (semverCompare ">= 1.18-0" .Capabilities.KubeVersion.Version)) }}
+{{- end }}
 
 {{/*
 Return if ingress supports pathType.
 */}}
 {{- define "grafana.ingress.supportsPathType" -}}
-  {{- or (eq (include "grafana.ingress.isStable" .) "true") (and (eq (include "grafana.ingress.apiVersion" .) "networking.k8s.io/v1beta1") (semverCompare ">= 1.18-0" .Capabilities.KubeVersion.Version)) -}}
-{{- end -}}
+{{- or (eq (include "grafana.ingress.isStable" .) "true") (and (eq (include "grafana.ingress.apiVersion" .) "networking.k8s.io/v1beta1") (semverCompare ">= 1.18-0" .Capabilities.KubeVersion.Version)) }}
+{{- end }}
diff --git a/charts/grafana/templates/_pod.tpl b/charts/grafana/templates/_pod.tpl
index 358345d5..627d9d79 100644
--- a/charts/grafana/templates/_pod.tpl
+++ b/charts/grafana/templates/_pod.tpl
@@ -1,8 +1,8 @@
 {{- define "grafana.pod" -}}
-{{- if .Values.schedulerName }}
-schedulerName: "{{ .Values.schedulerName }}"
+{{- with .Values.schedulerName }}
+schedulerName: "{{ . }}"
 {{- end }}
-serviceAccountName: {{ template "grafana.serviceAccountName" . }}
+serviceAccountName: {{ include "grafana.serviceAccountName" . }}
 automountServiceAccountToken: {{ .Values.serviceAccount.autoMount }}
 {{- with .Values.securityContext }}
 securityContext:
@@ -12,8 +12,8 @@ securityContext:
 hostAliases:
   {{- toYaml . | nindent 2 }}
 {{- end }}
-{{- if .Values.priorityClassName }}
-priorityClassName: {{ .Values.priorityClassName }}
+{{- with .Values.priorityClassName }}
+priorityClassName: {{ . }}
 {{- end }}
 {{- if ( or .Values.persistence.enabled .Values.dashboards .Values.extraInitContainers (and .Values.sidecar.datasources.enabled .Values.sidecar.datasources.initDatasources) (and .Values.sidecar.notifiers.enabled .Values.sidecar.notifiers.initNotifiers)) }}
 initContainers:
@@ -38,9 +38,9 @@ initContainers:
     volumeMounts:
       - name: storage
         mountPath: "/var/lib/grafana"
-{{- if .Values.persistence.subPath }}
+        {{- if .Values.persistence.subPath }}
         subPath: {{ tpl .Values.persistence.subPath . }}
-{{- end }}
+        {{- end }}
 {{- end }}
 {{- if .Values.dashboards }}
   - name: download-dashboards
@@ -57,36 +57,36 @@ initContainers:
       {{- toYaml . | nindent 6 }}
     {{- end }}
     env:
-{{- range $key, $value := .Values.downloadDashboards.env }}
+      {{- range $key, $value := .Values.downloadDashboards.env }}
       - name: "{{ $key }}"
         value: "{{ $value }}"
-{{- end }}
+      {{- end }}
     {{- with .Values.downloadDashboards.securityContext }}
     securityContext:
       {{- toYaml . | nindent 6 }}
     {{- end }}
-{{- if .Values.downloadDashboards.envFromSecret }}
+    {{- if .Values.downloadDashboards.envFromSecret }}
     envFrom:
       - secretRef:
           name: {{ tpl .Values.downloadDashboards.envFromSecret . }}
-{{- end }}
+    {{- end }}
     volumeMounts:
       - name: config
         mountPath: "/etc/grafana/download_dashboards.sh"
         subPath: download_dashboards.sh
       - name: storage
         mountPath: "/var/lib/grafana"
-{{- if .Values.persistence.subPath }}
+        {{- if .Values.persistence.subPath }}
         subPath: {{ tpl .Values.persistence.subPath . }}
-{{- end }}
-    {{- range .Values.extraSecretMounts }}
+        {{- end }}
+      {{- range .Values.extraSecretMounts }}
       - name: {{ .name }}
         mountPath: {{ .mountPath }}
         readOnly: {{ .readOnly }}
-    {{- end }}
+      {{- end }}
 {{- end }}
 {{- if and .Values.sidecar.datasources.enabled .Values.sidecar.datasources.initDatasources }}
-  - name: {{ template "grafana.name" . }}-init-sc-datasources
+  - name: {{ include "grafana.name" . }}-init-sc-datasources
     {{- if .Values.sidecar.image.sha }}
     image: "{{ .Values.sidecar.image.repository }}:{{ .Values.sidecar.image.tag }}@sha256:{{ .Values.sidecar.image.sha }}"
     {{- else }}
@@ -106,9 +106,9 @@ initContainers:
         value: "LIST"
       - name: LABEL
         value: "{{ .Values.sidecar.datasources.label }}"
-      {{- if .Values.sidecar.datasources.labelValue }}
+      {{- with .Values.sidecar.datasources.labelValue }}
       - name: LABEL_VALUE
-        value: {{ quote .Values.sidecar.datasources.labelValue }}
+        value: {{ quote . }}
       {{- end }}
       {{- if or .Values.sidecar.logLevel .Values.sidecar.datasources.logLevel }}
       - name: LOG_LEVEL
@@ -118,17 +118,17 @@ initContainers:
         value: "/etc/grafana/provisioning/datasources"
       - name: RESOURCE
         value: {{ quote .Values.sidecar.datasources.resource }}
-      {{- if .Values.sidecar.enableUniqueFilenames }}
+      {{- with .Values.sidecar.enableUniqueFilenames }}
       - name: UNIQUE_FILENAMES
-        value: "{{ .Values.sidecar.enableUniqueFilenames }}"
+        value: "{{ . }}"
       {{- end }}
       {{- if .Values.sidecar.datasources.searchNamespace }}
       - name: NAMESPACE
         value: "{{ tpl (.Values.sidecar.datasources.searchNamespace | join ",") . }}"
       {{- end }}
-      {{- if .Values.sidecar.skipTlsVerify }}
+      {{- with .Values.sidecar.skipTlsVerify }}
       - name: SKIP_TLS_VERIFY
-        value: "{{ .Values.sidecar.skipTlsVerify }}"
+        value: "{{ . }}"
       {{- end }}
     {{- with .Values.sidecar.resources }}
     resources:
@@ -143,7 +143,7 @@ initContainers:
         mountPath: "/etc/grafana/provisioning/datasources"
 {{- end }}
 {{- if and .Values.sidecar.notifiers.enabled .Values.sidecar.notifiers.initNotifiers }}
-  - name: {{ template "grafana.name" . }}-init-sc-notifiers
+  - name: {{ include "grafana.name" . }}-init-sc-notifiers
     {{- if .Values.sidecar.image.sha }}
     image: "{{ .Values.sidecar.image.repository }}:{{ .Values.sidecar.image.tag }}@sha256:{{ .Values.sidecar.image.sha }}"
     {{- else }}
@@ -163,9 +163,9 @@ initContainers:
         value: LIST
       - name: LABEL
         value: "{{ .Values.sidecar.notifiers.label }}"
-      {{- if .Values.sidecar.notifiers.labelValue }}
+      {{- with .Values.sidecar.notifiers.labelValue }}
       - name: LABEL_VALUE
-        value: {{ quote .Values.sidecar.notifiers.labelValue }}
+        value: {{ quote . }}
       {{- end }}
       {{- if or .Values.sidecar.logLevel .Values.sidecar.notifiers.logLevel }}
       - name: LOG_LEVEL
@@ -175,17 +175,17 @@ initContainers:
         value: "/etc/grafana/provisioning/notifiers"
       - name: RESOURCE
         value: {{ quote .Values.sidecar.notifiers.resource }}
-      {{- if .Values.sidecar.enableUniqueFilenames }}
+      {{- with .Values.sidecar.enableUniqueFilenames }}
       - name: UNIQUE_FILENAMES
-        value: "{{ .Values.sidecar.enableUniqueFilenames }}"
+        value: "{{ . }}"
       {{- end }}
       {{- if .Values.sidecar.notifiers.searchNamespace }}
       - name: NAMESPACE
         value: "{{ tpl (.Values.sidecar.notifiers.searchNamespace | join ",") . }}"
       {{- end }}
-      {{- if .Values.sidecar.skipTlsVerify }}
+      {{- with .Values.sidecar.skipTlsVerify }}
       - name: SKIP_TLS_VERIFY
-        value: "{{ .Values.sidecar.skipTlsVerify }}"
+        value: "{{ . }}"
       {{- end }}
     {{- with .Values.sidecar.livenessProbe }}
     livenessProbe:
@@ -212,17 +212,17 @@ initContainers:
 {{- end }}
 {{- if .Values.image.pullSecrets }}
 imagePullSecrets:
-{{- $root := . }}
-{{- range .Values.image.pullSecrets }}
+  {{- $root := . }}
+  {{- range .Values.image.pullSecrets }}
   - name: {{ tpl . $root }}
-{{- end}}
+  {{- end}}
 {{- end }}
 {{- if not .Values.enableKubeBackwardCompatibility }}
 enableServiceLinks: {{ .Values.enableServiceLinks }}
 {{- end }}
 containers:
 {{- if .Values.sidecar.alerts.enabled }}
-  - name: {{ template "grafana.name" . }}-sc-alerts
+  - name: {{ include "grafana.name" . }}-sc-alerts
     {{- if .Values.sidecar.image.sha }}
     image: "{{ .Values.sidecar.image.repository }}:{{ .Values.sidecar.image.tag }}@sha256:{{ .Values.sidecar.image.sha }}"
     {{- else }}
@@ -254,11 +254,11 @@ containers:
         value: "/etc/grafana/provisioning/alerting"
       - name: RESOURCE
         value: {{ quote .Values.sidecar.alerts.resource }}
-      {{- if .Values.sidecar.enableUniqueFilenames }}
+      {{- with .Values.sidecar.enableUniqueFilenames }}
       - name: UNIQUE_FILENAMES
-        value: "{{ .Values.sidecar.enableUniqueFilenames }}"
+        value: "{{ . }}"
       {{- end }}
-            {{- with .Values.sidecar.alerts.searchNamespace }}
+      {{- with .Values.sidecar.alerts.searchNamespace }}
       - name: NAMESPACE
         value: {{ . | join "," | quote }}
       {{- end }}
@@ -325,7 +325,7 @@ containers:
         mountPath: "/etc/grafana/provisioning/alerting"
 {{- end}}
 {{- if .Values.sidecar.dashboards.enabled }}
-  - name: {{ template "grafana.name" . }}-sc-dashboard
+  - name: {{ include "grafana.name" . }}-sc-dashboard
     {{- if .Values.sidecar.image.sha }}
     image: "{{ .Values.sidecar.image.repository }}:{{ .Values.sidecar.image.tag }}@sha256:{{ .Values.sidecar.image.sha }}"
     {{- else }}
@@ -357,25 +357,25 @@ containers:
         value: "{{ .Values.sidecar.dashboards.folder }}{{- with .Values.sidecar.dashboards.defaultFolderName }}/{{ . }}{{- end }}"
       - name: RESOURCE
         value: {{ quote .Values.sidecar.dashboards.resource }}
-      {{- if .Values.sidecar.enableUniqueFilenames }}
+      {{- with .Values.sidecar.enableUniqueFilenames }}
       - name: UNIQUE_FILENAMES
-        value: "{{ .Values.sidecar.enableUniqueFilenames }}"
+        value: "{{ . }}"
       {{- end }}
       {{- if .Values.sidecar.dashboards.searchNamespace }}
       - name: NAMESPACE
         value: "{{ tpl (.Values.sidecar.dashboards.searchNamespace | join ",") . }}"
       {{- end }}
-      {{- if .Values.sidecar.skipTlsVerify }}
+      {{- with .Values.sidecar.skipTlsVerify }}
       - name: SKIP_TLS_VERIFY
-        value: "{{ .Values.sidecar.skipTlsVerify }}"
+        value: "{{ . }}"
       {{- end }}
-      {{- if .Values.sidecar.dashboards.folderAnnotation }}
+      {{- with .Values.sidecar.dashboards.folderAnnotation }}
       - name: FOLDER_ANNOTATION
-        value: "{{ .Values.sidecar.dashboards.folderAnnotation }}"
+        value: "{{ . }}"
       {{- end }}
-      {{- if .Values.sidecar.dashboards.script }}
+      {{- with .Values.sidecar.dashboards.script }}
       - name: SCRIPT
-        value: "{{ .Values.sidecar.dashboards.script }}"
+        value: "{{ . }}"
       {{- end }}
       {{- if .Values.sidecar.dashboards.watchServerTimeout }}
       {{- if ne .Values.sidecar.dashboards.watchMethod "WATCH" }}
@@ -389,7 +389,7 @@ containers:
         {{- fail (printf "Cannot use .Values.sidecar.dashboards.watchClientTimeout with .Values.sidecar.dashboards.watchMethod %s" .Values.sidecar.dashboards.watchMethod) }}
       {{- end }}
       - name: WATCH_CLIENT_TIMEOUT
-        value: "{{ .Values.sidecar.dashboards.watchClientTimeout }}"
+        value: {{ .Values.sidecar.dashboards.watchClientTimeout | quote }}
       {{- end }}
     {{- with .Values.sidecar.livenessProbe }}
     livenessProbe:
@@ -410,12 +410,12 @@ containers:
     volumeMounts:
       - name: sc-dashboard-volume
         mountPath: {{ .Values.sidecar.dashboards.folder | quote }}
-      {{- if .Values.sidecar.dashboards.extraMounts }}
-      {{- toYaml .Values.sidecar.dashboards.extraMounts | trim | nindent 6}}
+      {{- with .Values.sidecar.dashboards.extraMounts }}
+      {{- toYaml . | trim | nindent 6 }}
       {{- end }}
 {{- end}}
 {{- if .Values.sidecar.datasources.enabled }}
-  - name: {{ template "grafana.name" . }}-sc-datasources
+  - name: {{ include "grafana.name" . }}-sc-datasources
     {{- if .Values.sidecar.image.sha }}
     image: "{{ .Values.sidecar.image.repository }}:{{ .Values.sidecar.image.tag }}@sha256:{{ .Values.sidecar.image.sha }}"
     {{- else }}
@@ -518,7 +518,7 @@ containers:
         mountPath: "/etc/grafana/provisioning/datasources"
 {{- end}}
 {{- if .Values.sidecar.notifiers.enabled }}
-  - name: {{ template "grafana.name" . }}-sc-notifiers
+  - name: {{ include "grafana.name" . }}-sc-notifiers
     {{- if .Values.sidecar.image.sha }}
     image: "{{ .Values.sidecar.image.repository }}:{{ .Values.sidecar.image.tag }}@sha256:{{ .Values.sidecar.image.sha }}"
     {{- else }}
@@ -621,7 +621,7 @@ containers:
         mountPath: "/etc/grafana/provisioning/notifiers"
 {{- end}}
 {{- if .Values.sidecar.plugins.enabled }}
-  - name: {{ template "grafana.name" . }}-sc-plugins
+  - name: {{ include "grafana.name" . }}-sc-plugins
     {{- if .Values.sidecar.image.sha }}
     image: "{{ .Values.sidecar.image.repository }}:{{ .Values.sidecar.image.tag }}@sha256:{{ .Values.sidecar.image.sha }}"
     {{- else }}
@@ -758,95 +758,95 @@ containers:
       {{- end }}
       - name: storage
         mountPath: "/var/lib/grafana"
-{{- if .Values.persistence.subPath }}
+        {{- if .Values.persistence.subPath }}
         subPath: {{ tpl .Values.persistence.subPath . }}
-{{- end }}
-{{- if .Values.dashboards }}
-{{- range $provider, $dashboards := .Values.dashboards }}
-{{- range $key, $value := $dashboards }}
-{{- if (or (hasKey $value "json") (hasKey $value "file")) }}
+        {{- end }}
+      {{- if .Values.dashboards }}
+      {{- range $provider, $dashboards := .Values.dashboards }}
+      {{- range $key, $value := $dashboards }}
+      {{- if (or (hasKey $value "json") (hasKey $value "file")) }}
       - name: dashboards-{{ $provider }}
         mountPath: "/var/lib/grafana/dashboards/{{ $provider }}/{{ $key }}.json"
         subPath: "{{ $key }}.json"
-{{- end }}
-{{- end }}
-{{- end }}
-{{- end -}}
-{{- if .Values.dashboardsConfigMaps }}
-{{- range (keys .Values.dashboardsConfigMaps | sortAlpha) }}
+      {{- end }}
+      {{- end }}
+      {{- end }}
+      {{- end -}}
+      {{- if .Values.dashboardsConfigMaps }}
+      {{- range (keys .Values.dashboardsConfigMaps | sortAlpha) }}
       - name: dashboards-{{ . }}
         mountPath: "/var/lib/grafana/dashboards/{{ . }}"
-{{- end }}
-{{- end }}
-{{- if .Values.datasources }}
-{{- range (keys .Values.datasources | sortAlpha) }}
+      {{- end }}
+      {{- end }}
+      {{- if .Values.datasources }}
+      {{- range (keys .Values.datasources | sortAlpha) }}
       - name: config
         mountPath: "/etc/grafana/provisioning/datasources/{{ . }}"
         subPath: {{ . | quote }}
-{{- end }}
-{{- end }}
-{{- if .Values.notifiers }}
-{{- range (keys .Values.notifiers | sortAlpha) }}
+      {{- end }}
+      {{- end }}
+      {{- if .Values.notifiers }}
+      {{- range (keys .Values.notifiers | sortAlpha) }}
       - name: config
         mountPath: "/etc/grafana/provisioning/notifiers/{{ . }}"
         subPath: {{ . | quote }}
-{{- end }}
-{{- end }}
-{{- if .Values.alerting }}
-{{- range (keys .Values.alerting | sortAlpha) }}
+      {{- end }}
+      {{- end }}
+      {{- if .Values.alerting }}
+      {{- range (keys .Values.alerting | sortAlpha) }}
       - name: config
         mountPath: "/etc/grafana/provisioning/alerting/{{ . }}"
         subPath: {{ . | quote }}
-{{- end }}
-{{- end }}
-{{- if .Values.dashboardProviders }}
-{{- range (keys .Values.dashboardProviders | sortAlpha) }}
+      {{- end }}
+      {{- end }}
+      {{- if .Values.dashboardProviders }}
+      {{- range (keys .Values.dashboardProviders | sortAlpha) }}
       - name: config
         mountPath: "/etc/grafana/provisioning/dashboards/{{ . }}"
         subPath: {{ . | quote }}
-{{- end }}
-{{- end }}
-{{- with .Values.sidecar.alerts.enabled }}
+      {{- end }}
+      {{- end }}
+      {{- with .Values.sidecar.alerts.enabled }}
       - name: sc-alerts-volume
         mountPath: "/etc/grafana/provisioning/alerting"
-{{- end}}
-{{- if .Values.sidecar.dashboards.enabled }}
+      {{- end}}
+      {{- if .Values.sidecar.dashboards.enabled }}
       - name: sc-dashboard-volume
         mountPath: {{ .Values.sidecar.dashboards.folder | quote }}
-{{ if .Values.sidecar.dashboards.SCProvider }}
+      {{ if .Values.sidecar.dashboards.SCProvider }}
       - name: sc-dashboard-provider
         mountPath: "/etc/grafana/provisioning/dashboards/sc-dashboardproviders.yaml"
         subPath: provider.yaml
-{{- end}}
-{{- end}}
-{{- if .Values.sidecar.datasources.enabled }}
+      {{- end}}
+      {{- end}}
+      {{- if .Values.sidecar.datasources.enabled }}
       - name: sc-datasources-volume
         mountPath: "/etc/grafana/provisioning/datasources"
-{{- end}}
-{{- if .Values.sidecar.plugins.enabled }}
+      {{- end}}
+      {{- if .Values.sidecar.plugins.enabled }}
       - name: sc-plugins-volume
         mountPath: "/etc/grafana/provisioning/plugins"
-{{- end}}
-{{- if .Values.sidecar.notifiers.enabled }}
+      {{- end}}
+      {{- if .Values.sidecar.notifiers.enabled }}
       - name: sc-notifiers-volume
         mountPath: "/etc/grafana/provisioning/notifiers"
-{{- end}}
-    {{- range .Values.extraSecretMounts }}
+      {{- end}}
+      {{- range .Values.extraSecretMounts }}
       - name: {{ .name }}
         mountPath: {{ .mountPath }}
         readOnly: {{ .readOnly }}
         subPath: {{ .subPath | default "" }}
-    {{- end }}
-    {{- range .Values.extraVolumeMounts }}
+      {{- end }}
+      {{- range .Values.extraVolumeMounts }}
       - name: {{ .name }}
         mountPath: {{ .mountPath }}
         subPath: {{ .subPath | default "" }}
         readOnly: {{ .readOnly }}
-    {{- end }}
-    {{- range .Values.extraEmptyDirMounts }}
+      {{- end }}
+      {{- range .Values.extraEmptyDirMounts }}
       - name: {{ .name }}
         mountPath: {{ .mountPath }}
-    {{- end }}
+      {{- end }}
     ports:
       - name: {{ .Values.podPortName }}
         containerPort: {{ .Values.service.targetPort }}
@@ -870,7 +870,7 @@ containers:
       - name: GF_INSTALL_PLUGINS
         valueFrom:
           configMapKeyRef:
-            name: {{ template "grafana.fullname" . }}
+            name: {{ include "grafana.fullname" . }}
             key: plugins
       {{- end }}
       {{- if .Values.smtp.existingSecret }}
@@ -887,9 +887,9 @@ containers:
       {{- end }}
       {{- if .Values.imageRenderer.enabled }}
       - name: GF_RENDERING_SERVER_URL
-        value: http://{{ template "grafana.fullname" . }}-image-renderer.{{ template "grafana.namespace" . }}:{{ .Values.imageRenderer.service.port }}/render
+        value: http://{{ include "grafana.fullname" . }}-image-renderer.{{ include "grafana.namespace" . }}:{{ .Values.imageRenderer.service.port }}/render
       - name: GF_RENDERING_CALLBACK_URL
-        value: {{ .Values.imageRenderer.grafanaProtocol }}://{{ template "grafana.fullname" . }}.{{ template "grafana.namespace" . }}:{{ .Values.service.port }}/{{ .Values.imageRenderer.grafanaSubPath }}
+        value: {{ .Values.imageRenderer.grafanaProtocol }}://{{ include "grafana.fullname" . }}.{{ include "grafana.namespace" . }}:{{ .Values.service.port }}/{{ .Values.imageRenderer.grafanaSubPath }}
       {{- end }}
       - name: GF_PATHS_DATA
         value: {{ (get .Values "grafana.ini").paths.data }}
@@ -899,35 +899,35 @@ containers:
         value: {{ (get .Values "grafana.ini").paths.plugins }}
       - name: GF_PATHS_PROVISIONING
         value: {{ (get .Values "grafana.ini").paths.provisioning }}
-    {{- range $key, $value := .Values.envValueFrom }}
+      {{- range $key, $value := .Values.envValueFrom }}
       - name: {{ $key | quote }}
         valueFrom:
-{{ tpl (toYaml $value) $ | indent 10 }}
-    {{- end }}
-{{- range $key, $value := .Values.env }}
+          {{- tpl (toYaml $value) $ | nindent 10 }}
+      {{- end }}
+      {{- range $key, $value := .Values.env }}
       - name: "{{ tpl $key $ }}"
         value: "{{ tpl (print $value) $ }}"
-{{- end }}
+      {{- end }}
     {{- if or .Values.envFromSecret (or .Values.envRenderSecret .Values.envFromSecrets) .Values.envFromConfigMaps }}
     envFrom:
-    {{- if .Values.envFromSecret }}
+      {{- if .Values.envFromSecret }}
       - secretRef:
           name: {{ tpl .Values.envFromSecret . }}
-    {{- end }}
-    {{- if .Values.envRenderSecret }}
+      {{- end }}
+      {{- if .Values.envRenderSecret }}
       - secretRef:
-          name: {{ template "grafana.fullname" . }}-env
-    {{- end }}
-    {{- range .Values.envFromSecrets }}
+          name: {{ include "grafana.fullname" . }}-env
+      {{- end }}
+      {{- range .Values.envFromSecrets }}
       - secretRef:
           name: {{ tpl .name $ }}
           optional: {{ .optional | default false }}
-    {{- end }}
-    {{- range .Values.envFromConfigMaps }}
+      {{- end }}
+      {{- range .Values.envFromConfigMaps }}
       - configMapRef:
           name: {{ tpl .name $ }}
           optional: {{ .optional | default false }}
-    {{- end }}
+      {{- end }}
     {{- end }}
     {{- with .Values.livenessProbe }}
     livenessProbe:
@@ -937,15 +937,16 @@ containers:
     readinessProbe:
       {{- toYaml . | nindent 6 }}
     {{- end }}
-{{- if .Values.lifecycleHooks }}
-    lifecycle: {{ tpl (.Values.lifecycleHooks | toYaml) . | nindent 6 }}
-{{- end }}
+    {{- if .Values.lifecycleHooks }}
+    lifecycle:
+      {{- tpl (.Values.lifecycleHooks | toYaml) . | nindent 6 }}
+    {{- end }}
     {{- with .Values.resources }}
     resources:
       {{- toYaml . | nindent 6 }}
     {{- end }}
 {{- with .Values.extraContainers }}
-{{ tpl . $ | indent 2 }}
+  {{- tpl . $ | nindent 2 }}
 {{- end }}
 {{- with .Values.nodeSelector }}
 nodeSelector:
@@ -954,7 +955,7 @@ nodeSelector:
 {{- $root := . }}
 {{- with .Values.affinity }}
 affinity:
-{{ tpl (toYaml .) $root | indent 2 }}
+  {{- tpl (toYaml .) $root | nindent 2 }}
 {{- end }}
 {{- with .Values.topologySpreadConstraints }}
 topologySpreadConstraints:
@@ -967,30 +968,31 @@ tolerations:
 volumes:
   - name: config
     configMap:
-      name: {{ template "grafana.fullname" . }}
-{{- $root := . }}
-{{- range .Values.extraConfigmapMounts }}
+      name: {{ include "grafana.fullname" . }}
+  {{- $root := . }}
+  {{- range .Values.extraConfigmapMounts }}
   - name: {{ tpl .name $root }}
     configMap:
       name: {{ tpl .configMap $root }}
-      {{- if .items }}
-      items: {{ toYaml .items | nindent 6 }}
+      {{- with .items }}
+      items:
+        {{- toYaml . | nindent 8 }}
       {{- end }}
-{{- end }}
+  {{- end }}
   {{- if .Values.dashboards }}
-    {{- range (keys .Values.dashboards | sortAlpha) }}
+  {{- range (keys .Values.dashboards | sortAlpha) }}
   - name: dashboards-{{ . }}
     configMap:
-      name: {{ template "grafana.fullname" $ }}-dashboards-{{ . }}
-    {{- end }}
+      name: {{ include "grafana.fullname" $ }}-dashboards-{{ . }}
+  {{- end }}
   {{- end }}
   {{- if .Values.dashboardsConfigMaps }}
-    {{ $root := . }}
-    {{- range $provider, $name := .Values.dashboardsConfigMaps }}
+  {{ $root := . }}
+  {{- range $provider, $name := .Values.dashboardsConfigMaps }}
   - name: dashboards-{{ $provider }}
     configMap:
       name: {{ tpl $name $root }}
-    {{- end }}
+  {{- end }}
   {{- end }}
   {{- if .Values.ldap.enabled }}
   - name: ldap
@@ -998,82 +1000,82 @@ volumes:
       {{- if .Values.ldap.existingSecret }}
       secretName: {{ .Values.ldap.existingSecret }}
       {{- else }}
-      secretName: {{ template "grafana.fullname" . }}
+      secretName: {{ include "grafana.fullname" . }}
       {{- end }}
       items:
         - key: ldap-toml
           path: ldap.toml
   {{- end }}
-{{- if and .Values.persistence.enabled (eq .Values.persistence.type "pvc") }}
+  {{- if and .Values.persistence.enabled (eq .Values.persistence.type "pvc") }}
   - name: storage
     persistentVolumeClaim:
       claimName: {{ tpl (.Values.persistence.existingClaim | default (include "grafana.fullname" .)) . }}
-{{- else if and .Values.persistence.enabled (eq .Values.persistence.type "statefulset") }}
-# nothing
-{{- else }}
+  {{- else if and .Values.persistence.enabled (eq .Values.persistence.type "statefulset") }}
+  # nothing
+  {{- else }}
   - name: storage
-{{- if .Values.persistence.inMemory.enabled }}
+    {{- if .Values.persistence.inMemory.enabled }}
     emptyDir:
       medium: Memory
-{{- if .Values.persistence.inMemory.sizeLimit }}
-      sizeLimit: {{ .Values.persistence.inMemory.sizeLimit }}
-{{- end -}}
-{{- else }}
+      {{- with .Values.persistence.inMemory.sizeLimit }}
+      sizeLimit: {{ . }}
+      {{- end -}}
+    {{- else }}
     emptyDir: {}
-{{- end -}}
-{{- end -}}
-{{- if .Values.sidecar.alerts.enabled }}
+    {{- end -}}
+  {{- end -}}
+  {{- if .Values.sidecar.alerts.enabled }}
   - name: sc-alerts-volume
-{{- if .Values.sidecar.alerts.sizeLimit }}
     emptyDir:
-      sizeLimit: {{ .Values.sidecar.alerts.sizeLimit }}
-{{- else }}
-    emptyDir: {}
-{{- end -}}
-{{- end -}}
-{{- if .Values.sidecar.dashboards.enabled }}
+      {{- with .Values.sidecar.alerts.sizeLimit }}
+      sizeLimit: {{ . }}
+      {{- else }}
+      {}
+      {{- end -}}
+  {{- end -}}
+  {{- if .Values.sidecar.dashboards.enabled }}
   - name: sc-dashboard-volume
-{{- if .Values.sidecar.dashboards.sizeLimit }}
     emptyDir:
-      sizeLimit: {{ .Values.sidecar.dashboards.sizeLimit }}
-{{- else }}
-    emptyDir: {}
-{{- end -}}
-{{- if .Values.sidecar.dashboards.SCProvider }}
+      {{- with .Values.sidecar.dashboards.sizeLimit }}
+      sizeLimit: {{ . }}
+      {{- else }}
+      {}
+      {{- end -}}
+  {{- if .Values.sidecar.dashboards.SCProvider }}
   - name: sc-dashboard-provider
     configMap:
-      name: {{ template "grafana.fullname" . }}-config-dashboards
-{{- end }}
-{{- end }}
-{{- if .Values.sidecar.datasources.enabled }}
+      name: {{ include "grafana.fullname" . }}-config-dashboards
+  {{- end }}
+  {{- end }}
+  {{- if .Values.sidecar.datasources.enabled }}
   - name: sc-datasources-volume
-{{- if .Values.sidecar.datasources.sizeLimit }}
     emptyDir:
-      sizeLimit: {{ .Values.sidecar.datasources.sizeLimit }}
-{{- else }}
-    emptyDir: {}
-{{- end -}}
-{{- end -}}
-{{- if .Values.sidecar.plugins.enabled }}
+      {{- with .Values.sidecar.datasources.sizeLimit }}
+      sizeLimit: {{ . }}
+      {{- else }}
+      {}
+      {{- end -}}
+  {{- end -}}
+  {{- if .Values.sidecar.plugins.enabled }}
   - name: sc-plugins-volume
-{{- if .Values.sidecar.plugins.sizeLimit }}
     emptyDir:
-      sizeLimit: {{ .Values.sidecar.plugins.sizeLimit }}
-{{- else }}
-    emptyDir: {}
-{{- end -}}
-{{- end -}}
-{{- if .Values.sidecar.notifiers.enabled }}
+      {{- with .Values.sidecar.plugins.sizeLimit }}
+      sizeLimit: {{ . }}
+      {{- else }}
+      {}
+      {{- end -}}
+  {{- end -}}
+  {{- if .Values.sidecar.notifiers.enabled }}
   - name: sc-notifiers-volume
-{{- if .Values.sidecar.notifiers.sizeLimit }}
     emptyDir:
-      sizeLimit: {{ .Values.sidecar.notifiers.sizeLimit }}
-{{- else }}
-    emptyDir: {}
-{{- end -}}
-{{- end -}}
-{{- range .Values.extraSecretMounts }}
-{{- if .secretName }}
+      {{- with .Values.sidecar.notifiers.sizeLimit }}
+      sizeLimit: {{ . }}
+      {{- else }}
+      {}
+      {{- end -}}
+  {{- end -}}
+  {{- range .Values.extraSecretMounts }}
+  {{- if .secretName }}
   - name: {{ .name }}
     secret:
       secretName: {{ .secretName }}
@@ -1081,15 +1083,15 @@ volumes:
       {{- if .items }}
       items: {{ toYaml .items | nindent 6 }}
       {{- end }}
-{{- else if .projected }}
+  {{- else if .projected }}
   - name: {{ .name }}
     projected: {{- toYaml .projected | nindent 6 }}
-{{- else if .csi }}
+  {{- else if .csi }}
   - name: {{ .name }}
     csi: {{- toYaml .csi | nindent 6 }}
-{{- end }}
-{{- end }}
-{{- range .Values.extraVolumeMounts }}
+  {{- end }}
+  {{- end }}
+  {{- range .Values.extraVolumeMounts }}
   - name: {{ .name }}
     {{- if .existingClaim }}
     persistentVolumeClaim:
@@ -1100,16 +1102,16 @@ volumes:
     {{- else if .csi }}
     csi:
       data:
-        {{ toYaml .data | nindent 6 }}
+        {{- toYaml .data | nindent 8 }}
     {{- else }}
     emptyDir: {}
     {{- end }}
-{{- end }}
-{{- range .Values.extraEmptyDirMounts }}
+  {{- end }}
+  {{- range .Values.extraEmptyDirMounts }}
   - name: {{ .name }}
     emptyDir: {}
-{{- end -}}
-{{- if .Values.extraContainerVolumes }}
-{{ tpl (toYaml .Values.extraContainerVolumes) . | indent 2 }}
-{{- end }}
+  {{- end -}}
+  {{- if .Values.extraContainerVolumes }}
+  {{- tpl (toYaml .Values.extraContainerVolumes) . | nindent 2 }}
+  {{- end }}
 {{- end }}
diff --git a/charts/grafana/templates/image-renderer-network-policy.yaml b/charts/grafana/templates/image-renderer-network-policy.yaml
index 0d9bdfe4..ac62679a 100644
--- a/charts/grafana/templates/image-renderer-network-policy.yaml
+++ b/charts/grafana/templates/image-renderer-network-policy.yaml
@@ -1,10 +1,10 @@
-{{- if and (.Values.imageRenderer.enabled) (.Values.imageRenderer.networkPolicy.limitIngress) }}
+{{- if and .Values.imageRenderer.enabled .Values.imageRenderer.networkPolicy.limitIngress }}
 ---
 apiVersion: networking.k8s.io/v1
 kind: NetworkPolicy
 metadata:
-  name: {{ template "grafana.fullname" . }}-image-renderer-ingress
-  namespace: {{ template "grafana.namespace" . }}
+  name: {{ include "grafana.fullname" . }}-image-renderer-ingress
+  namespace: {{ include "grafana.namespace" . }}
   annotations:
     comment: Limit image-renderer ingress traffic from grafana
 spec:
@@ -12,7 +12,7 @@ spec:
     matchLabels:
       {{- include "grafana.imageRenderer.selectorLabels" . | nindent 6 }}
       {{- if .Values.imageRenderer.podLabels }}
-        {{ toYaml .Values.imageRenderer.podLabels | nindent 6 }}
+      {{- toYaml .Values.imageRenderer.podLabels | nindent 6 }}
       {{- end }}
 
   policyTypes:
@@ -24,30 +24,30 @@ spec:
       from:
         - namespaceSelector:
             matchLabels:
-              name: {{ template "grafana.namespace" . }}
+              name: {{ include "grafana.namespace" . }}
           podSelector:
             matchLabels:
               {{- include "grafana.selectorLabels" . | nindent 14 }}
-              {{- if .Values.podLabels }}
-                {{ toYaml .Values.podLabels | nindent 14 }}
+              {{- with .Values.podLabels }}
+              {{- toYaml . | nindent 14 }}
               {{- end }}
-{{ end }}
+{{- end }}
 
-{{- if and (.Values.imageRenderer.enabled) (.Values.imageRenderer.networkPolicy.limitEgress) }}
+{{- if and .Values.imageRenderer.enabled .Values.imageRenderer.networkPolicy.limitEgress }}
 ---
 apiVersion: networking.k8s.io/v1
 kind: NetworkPolicy
 metadata:
-  name: {{ template "grafana.fullname" . }}-image-renderer-egress
-  namespace: {{ template "grafana.namespace" . }}
+  name: {{ include "grafana.fullname" . }}-image-renderer-egress
+  namespace: {{ include "grafana.namespace" . }}
   annotations:
     comment: Limit image-renderer egress traffic to grafana
 spec:
   podSelector:
     matchLabels:
       {{- include "grafana.imageRenderer.selectorLabels" . | nindent 6 }}
-      {{- if .Values.imageRenderer.podLabels }}
-        {{ toYaml .Values.imageRenderer.podLabels | nindent 6 }}
+      {{- with .Values.imageRenderer.podLabels }}
+      {{- toYaml . | nindent 6 }}
       {{- end }}
 
   policyTypes:
@@ -67,7 +67,7 @@ spec:
         - podSelector:
             matchLabels:
               {{- include "grafana.selectorLabels" . | nindent 14 }}
-              {{- if .Values.podLabels }}
-                {{ toYaml .Values.podLabels | nindent 14 }}
+              {{- with .Values.podLabels }}
+              {{- toYaml . | nindent 14 }}
               {{- end }}
-{{ end }}
+{{- end }}
diff --git a/charts/grafana/templates/image-renderer-service.yaml b/charts/grafana/templates/image-renderer-service.yaml
index fcf707a3..a2963450 100644
--- a/charts/grafana/templates/image-renderer-service.yaml
+++ b/charts/grafana/templates/image-renderer-service.yaml
@@ -1,33 +1,31 @@
-{{ if .Values.imageRenderer.enabled }}
-{{ if .Values.imageRenderer.service.enabled }}
+{{- if and .Values.imageRenderer.enabled .Values.imageRenderer.service.enabled }}
 apiVersion: v1
 kind: Service
 metadata:
-  name: {{ template "grafana.fullname" . }}-image-renderer
-  namespace: {{ template "grafana.namespace" . }}
+  name: {{ include "grafana.fullname" . }}-image-renderer
+  namespace: {{ include "grafana.namespace" . }}
   labels:
     {{- include "grafana.imageRenderer.labels" . | nindent 4 }}
-{{- if .Values.imageRenderer.service.labels }}
-{{ toYaml .Values.imageRenderer.service.labels | indent 4 }}
-{{- end }}
-{{- with .Values.imageRenderer.service.annotations }}
+    {{- if .Values.imageRenderer.service.labels }}
+    {{- toYaml . | indent 4 }}
+    {{- end }}
+  {{- with .Values.imageRenderer.service.annotations }}
   annotations:
-{{ toYaml . | indent 4 }}
-{{- end }}
+    {{- toYaml . | nindent 4 }}
+  {{- end }}
 spec:
   type: ClusterIP
-  {{- if .Values.imageRenderer.service.clusterIP }}
-  clusterIP: {{ .Values.imageRenderer.service.clusterIP }}
-  {{end}}
+  {{- with .Values.imageRenderer.service.clusterIP }}
+  clusterIP: {{ . }}
+  {{- end }}
   ports:
     - name: {{ .Values.imageRenderer.service.portName }}
       port: {{ .Values.imageRenderer.service.port }}
       protocol: TCP
       targetPort: {{ .Values.imageRenderer.service.targetPort }}
-      {{- if .Values.imageRenderer.appProtocol }}
-      appProtocol: {{ .Values.imageRenderer.appProtocol }}
+      {{- with .Values.imageRenderer.appProtocol }}
+      appProtocol: {{ . }}
       {{- end }}
   selector:
     {{- include "grafana.imageRenderer.selectorLabels" . | nindent 4 }}
-{{ end }}
-{{ end }}
+{{- end }}
diff --git a/charts/grafana/templates/ingress.yaml b/charts/grafana/templates/ingress.yaml
index 7699ceca..0d345dee 100644
--- a/charts/grafana/templates/ingress.yaml
+++ b/charts/grafana/templates/ingress.yaml
@@ -11,13 +11,13 @@ apiVersion: {{ include "grafana.ingress.apiVersion" . }}
 kind: Ingress
 metadata:
   name: {{ $fullName }}
-  namespace: {{ template "grafana.namespace" . }}
+  namespace: {{ include "grafana.namespace" . }}
   labels:
     {{- include "grafana.labels" . | nindent 4 }}
-{{- if .Values.ingress.labels }}
-{{ toYaml .Values.ingress.labels | indent 4 }}
-{{- end }}
-  {{- if .Values.ingress.annotations }}
+    {{- if .Values.ingress.labels }}
+    {{- toYaml .Values.ingress.labels | indent 4 }}
+    {{- end }}
+  {{- with .Values.ingress.annotations }}
   annotations:
     {{- range $key, $value := .Values.ingress.annotations }}
     {{ $key }}: {{ tpl $value $ | quote }}
@@ -27,19 +27,19 @@ spec:
   {{- if and $ingressSupportsIngressClassName .Values.ingress.ingressClassName }}
   ingressClassName: {{ .Values.ingress.ingressClassName }}
   {{- end -}}
-{{- if .Values.ingress.tls }}
+  {{- with .Values.ingress.tls }}
   tls:
-{{ tpl (toYaml .Values.ingress.tls) $ | indent 4 }}
-{{- end }}
+    {{- tpl (toYaml .Values.ingress.tls) $ | nindent 4 }}
+  {{- end }}
   rules:
   {{- if .Values.ingress.hosts  }}
   {{- range .Values.ingress.hosts }}
     - host: {{ tpl . $}}
       http:
         paths:
-{{- if $extraPaths }}
-{{ toYaml $extraPaths | indent 10 }}
-{{- end }}
+          {{- with $extraPaths }}
+          {{- toYaml . | indent 10 }}
+          {{- end }}
           - path: {{ $ingressPath }}
             {{- if $ingressSupportsPathType }}
             pathType: {{ $ingressPathType }}
@@ -68,11 +68,11 @@ spec:
               serviceName: {{ $fullName }}
               servicePort: {{ $servicePort }}
               {{- end }}
-            {{- if $ingressPath }}
-            path: {{ $ingressPath }}
+            {{- with $ingressPath }}
+            path: {{ . }}
             {{- end }}
-            {{- if $ingressSupportsPathType }}
-            pathType: {{ $ingressPathType }}
+            {{- with $ingressSupportsPathType }}
+            pathType: {{ . }}
             {{- end }}
   {{- end -}}
 {{- end }}
diff --git a/charts/grafana/templates/networkpolicy.yaml b/charts/grafana/templates/networkpolicy.yaml
index b751d943..ea4578be 100644
--- a/charts/grafana/templates/networkpolicy.yaml
+++ b/charts/grafana/templates/networkpolicy.yaml
@@ -2,12 +2,12 @@
 apiVersion: networking.k8s.io/v1
 kind: NetworkPolicy
 metadata:
-  name: {{ template "grafana.fullname" . }}
-  namespace: {{ template "grafana.namespace" . }}
+  name: {{ include "grafana.fullname" . }}
+  namespace: {{ include "grafana.namespace" . }}
   labels:
     {{- include "grafana.labels" . | nindent 4 }}
     {{- with .Values.labels }}
-    {{ toYaml . | nindent 4 }}
+    {{- toYaml . | nindent 4 }}
     {{- end }}
   {{- with .Values.annotations }}
   annotations:
@@ -23,7 +23,7 @@ spec:
     {{- end }}
   podSelector:
     matchLabels:
-    {{- include "grafana.selectorLabels" . | nindent 6 }}
+      {{- include "grafana.selectorLabels" . | nindent 6 }}
 
   {{- if .Values.networkPolicy.egress.enabled }}
   egress:
@@ -38,7 +38,7 @@ spec:
       from:
         - podSelector:
             matchLabels:
-              {{ template "grafana.fullname" . }}-client: "true"
+              {{ include "grafana.fullname" . }}-client: "true"
         {{- with .Values.networkPolicy.explicitNamespacesSelector }}
         - namespaceSelector:
             {{- toYaml . | nindent 12 }}
diff --git a/charts/grafana/templates/poddisruptionbudget.yaml b/charts/grafana/templates/poddisruptionbudget.yaml
index 70901b70..05251214 100644
--- a/charts/grafana/templates/poddisruptionbudget.yaml
+++ b/charts/grafana/templates/poddisruptionbudget.yaml
@@ -2,20 +2,20 @@
 apiVersion: {{ include "grafana.podDisruptionBudget.apiVersion" . }}
 kind: PodDisruptionBudget
 metadata:
-  name: {{ template "grafana.fullname" . }}
-  namespace: {{ template "grafana.namespace" . }}
+  name: {{ include "grafana.fullname" . }}
+  namespace: {{ include "grafana.namespace" . }}
   labels:
     {{- include "grafana.labels" . | nindent 4 }}
-{{- if .Values.labels }}
-{{ toYaml .Values.labels | indent 4 }}
-{{- end }}
+    {{- with .Values.labels }}
+    {{- toYaml . | nindent 4 }}
+    {{- end }}
 spec:
-{{- if .Values.podDisruptionBudget.minAvailable }}
-  minAvailable: {{ .Values.podDisruptionBudget.minAvailable }}
-{{- end }}
-{{- if .Values.podDisruptionBudget.maxUnavailable }}
-  maxUnavailable: {{ .Values.podDisruptionBudget.maxUnavailable }}
-{{- end }}
+  {{- with .Values.podDisruptionBudget.minAvailable }}
+  minAvailable: {{ . }}
+  {{- end }}
+  {{- with .Values.podDisruptionBudget.maxUnavailable }}
+  maxUnavailable: {{ . }}
+  {{- end }}
   selector:
     matchLabels:
       {{- include "grafana.selectorLabels" . | nindent 6 }}
diff --git a/charts/grafana/templates/podsecuritypolicy.yaml b/charts/grafana/templates/podsecuritypolicy.yaml
index d9905c62..eed7af95 100644
--- a/charts/grafana/templates/podsecuritypolicy.yaml
+++ b/charts/grafana/templates/podsecuritypolicy.yaml
@@ -1,9 +1,8 @@
-{{- if .Values.rbac.pspEnabled }}
-{{- if .Capabilities.APIVersions.Has "policy/v1beta1/PodSecurityPolicy" }}
+{{- if and .Values.rbac.pspEnabled (.Capabilities.APIVersions.Has "policy/v1beta1/PodSecurityPolicy") }}
 apiVersion: policy/v1beta1
 kind: PodSecurityPolicy
 metadata:
-  name: {{ template "grafana.fullname" . }}
+  name: {{ include "grafana.fullname" . }}
   labels:
     {{- include "grafana.labels" . | nindent 4 }}
   annotations:
@@ -48,4 +47,3 @@ spec:
         max: 65535
   readOnlyRootFilesystem: false
 {{- end }}
-{{- end }}
diff --git a/charts/grafana/templates/pvc.yaml b/charts/grafana/templates/pvc.yaml
index 65dd1002..cc4e641d 100644
--- a/charts/grafana/templates/pvc.yaml
+++ b/charts/grafana/templates/pvc.yaml
@@ -2,8 +2,8 @@
 apiVersion: v1
 kind: PersistentVolumeClaim
 metadata:
-  name: {{ template "grafana.fullname" . }}
-  namespace: {{ template "grafana.namespace" . }}
+  name: {{ include "grafana.fullname" . }}
+  namespace: {{ include "grafana.namespace" . }}
   labels:
     {{- include "grafana.labels" . | nindent 4 }}
     {{- with .Values.persistence.extraPvcLabels }}
@@ -11,11 +11,11 @@ metadata:
     {{- end }}
   {{- with .Values.persistence.annotations  }}
   annotations:
-{{ toYaml . | indent 4 }}
+    {{- toYaml . | nindent 4 }}
   {{- end }}
   {{- with .Values.persistence.finalizers  }}
   finalizers:
-{{ toYaml . | indent 4 }}
+    {{- toYaml . | nindent 4 }}
   {{- end }}
 spec:
   accessModes:
@@ -25,12 +25,12 @@ spec:
   resources:
     requests:
       storage: {{ .Values.persistence.size | quote }}
-  {{- if .Values.persistence.storageClassName }}
-  storageClassName: {{ .Values.persistence.storageClassName }}
-  {{- end -}}
+  {{- with .Values.persistence.storageClassName }}
+  storageClassName: {{ . }}
+  {{- end }}
   {{- with .Values.persistence.selectorLabels }}
   selector:
     matchLabels:
-{{ toYaml . | indent 6 }}
+    {{- toYaml . | nindent 6 }}
   {{- end }}
 {{- end -}}
diff --git a/charts/grafana/templates/role.yaml b/charts/grafana/templates/role.yaml
index ff2160f4..9f0d53bb 100644
--- a/charts/grafana/templates/role.yaml
+++ b/charts/grafana/templates/role.yaml
@@ -1,31 +1,31 @@
 {{- if and .Values.rbac.create (not .Values.rbac.useExistingRole) -}}
-apiVersion: {{ template "grafana.rbac.apiVersion" . }}
+apiVersion: {{ include "grafana.rbac.apiVersion" . }}
 kind: Role
 metadata:
-  name: {{ template "grafana.fullname" . }}
-  namespace: {{ template "grafana.namespace" . }}
+  name: {{ include "grafana.fullname" . }}
+  namespace: {{ include "grafana.namespace" . }}
   labels:
     {{- include "grafana.labels" . | nindent 4 }}
-{{- with .Values.annotations }}
+  {{- with .Values.annotations }}
   annotations:
-{{ toYaml . | indent 4 }}
-{{- end }}
-{{- if or .Values.rbac.pspEnabled (and .Values.rbac.namespaced (or .Values.sidecar.dashboards.enabled (or .Values.sidecar.datasources.enabled (or .Values.sidecar.plugins.enabled .Values.rbac.extraRoleRules)))) }}
+    {{- toYaml . | nindent 4 }}
+  {{- end }}
+{{- if or .Values.rbac.pspEnabled (and .Values.rbac.namespaced (or .Values.sidecar.dashboards.enabled .Values.sidecar.datasources.enabled .Values.sidecar.plugins.enabled .Values.rbac.extraRoleRules)) }}
 rules:
-{{- if .Values.rbac.pspEnabled }}
-- apiGroups:      ['extensions']
-  resources:      ['podsecuritypolicies']
-  verbs:          ['use']
-  resourceNames:  [{{ template "grafana.fullname" . }}]
-{{- end }}
-{{- if and .Values.rbac.namespaced (or .Values.sidecar.dashboards.enabled (or .Values.sidecar.datasources.enabled .Values.sidecar.plugins.enabled)) }}
-- apiGroups: [""] # "" indicates the core API group
-  resources: ["configmaps", "secrets"]
-  verbs: ["get", "watch", "list"]
-{{- end }}
-{{- with .Values.rbac.extraRoleRules }}
-{{ toYaml . | indent 0 }}
-{{- end}}
+  {{- if .Values.rbac.pspEnabled }}
+  - apiGroups:      ['extensions']
+    resources:      ['podsecuritypolicies']
+    verbs:          ['use']
+    resourceNames:  [{{ include "grafana.fullname" . }}]
+  {{- end }}
+  {{- if and .Values.rbac.namespaced (or .Values.sidecar.dashboards.enabled or .Values.sidecar.datasources.enabled .Values.sidecar.plugins.enabled) }}
+  - apiGroups: [""] # "" indicates the core API group
+    resources: ["configmaps", "secrets"]
+    verbs: ["get", "watch", "list"]
+  {{- end }}
+  {{- with .Values.rbac.extraRoleRules }}
+  {{- toYaml . | nindent 2 }}
+  {{- end}}
 {{- else }}
 rules: []
 {{- end }}
diff --git a/charts/grafana/templates/rolebinding.yaml b/charts/grafana/templates/rolebinding.yaml
index e0107255..5814f309 100644
--- a/charts/grafana/templates/rolebinding.yaml
+++ b/charts/grafana/templates/rolebinding.yaml
@@ -1,25 +1,25 @@
 {{- if .Values.rbac.create -}}
-apiVersion: {{ template "grafana.rbac.apiVersion" . }}
+apiVersion: {{ include "grafana.rbac.apiVersion" . }}
 kind: RoleBinding
 metadata:
-  name: {{ template "grafana.fullname" . }}
-  namespace: {{ template "grafana.namespace" . }}
+  name: {{ include "grafana.fullname" . }}
+  namespace: {{ include "grafana.namespace" . }}
   labels:
     {{- include "grafana.labels" . | nindent 4 }}
-{{- with .Values.annotations }}
+  {{- with .Values.annotations }}
   annotations:
-{{ toYaml . | indent 4 }}
-{{- end }}
+    {{- toYaml . | nindent 4 }}
+  {{- end }}
 roleRef:
   apiGroup: rbac.authorization.k8s.io
   kind: Role
-{{- if (not .Values.rbac.useExistingRole) }}
-  name: {{ template "grafana.fullname" . }}
-{{- else }}
+  {{- if .Values.rbac.useExistingRole }}
   name: {{ .Values.rbac.useExistingRole }}
-{{- end }}
+  {{- else }}
+  name: {{ include "grafana.fullname" . }}
+  {{- end }}
 subjects:
 - kind: ServiceAccount
-  name: {{ template "grafana.serviceAccountName" . }}
-  namespace: {{ template "grafana.namespace" . }}
+  name: {{ include "grafana.serviceAccountName" . }}
+  namespace: {{ include "grafana.namespace" . }}
 {{- end -}}
diff --git a/charts/grafana/templates/secret-env.yaml b/charts/grafana/templates/secret-env.yaml
index 5c09313e..213ad452 100644
--- a/charts/grafana/templates/secret-env.yaml
+++ b/charts/grafana/templates/secret-env.yaml
@@ -2,8 +2,8 @@
 apiVersion: v1
 kind: Secret
 metadata:
-  name: {{ template "grafana.fullname" . }}-env
-  namespace: {{ template "grafana.namespace" . }}
+  name: {{ include "grafana.fullname" . }}-env
+  namespace: {{ include "grafana.namespace" . }}
   labels:
     {{- include "grafana.labels" . | nindent 4 }}
 type: Opaque
diff --git a/charts/grafana/templates/secret.yaml b/charts/grafana/templates/secret.yaml
index c8aa750a..5cbd5274 100644
--- a/charts/grafana/templates/secret.yaml
+++ b/charts/grafana/templates/secret.yaml
@@ -2,14 +2,14 @@
 apiVersion: v1
 kind: Secret
 metadata:
-  name: {{ template "grafana.fullname" . }}
-  namespace: {{ template "grafana.namespace" . }}
+  name: {{ include "grafana.fullname" . }}
+  namespace: {{ include "grafana.namespace" . }}
   labels:
     {{- include "grafana.labels" . | nindent 4 }}
-{{- with .Values.annotations }}
+  {{- with .Values.annotations }}
   annotations:
-{{ toYaml . | indent 4 }}
-{{- end }}
+    {{- toYaml . | nindent 4 }}
+  {{- end }}
 type: Opaque
 data:
   {{- if and (not .Values.env.GF_SECURITY_DISABLE_INITIAL_ADMIN_CREATION) (not .Values.admin.existingSecret) (not .Values.env.GF_SECURITY_ADMIN_PASSWORD__FILE) (not .Values.env.GF_SECURITY_ADMIN_PASSWORD) }}
@@ -17,7 +17,7 @@ data:
   {{- if .Values.adminPassword }}
   admin-password: {{ .Values.adminPassword | b64enc | quote }}
   {{- else }}
-  admin-password: {{ template "grafana.password" . }}
+  admin-password: {{ include "grafana.password" . }}
   {{- end }}
   {{- end }}
   {{- if not .Values.ldap.existingSecret }}
diff --git a/charts/grafana/templates/service.yaml b/charts/grafana/templates/service.yaml
index d0a1756c..bbed4bd1 100644
--- a/charts/grafana/templates/service.yaml
+++ b/charts/grafana/templates/service.yaml
@@ -2,51 +2,51 @@
 apiVersion: v1
 kind: Service
 metadata:
-  name: {{ template "grafana.fullname" . }}
-  namespace: {{ template "grafana.namespace" . }}
+  name: {{ include "grafana.fullname" . }}
+  namespace: {{ include "grafana.namespace" . }}
   labels:
     {{- include "grafana.labels" . | nindent 4 }}
-{{- if .Values.service.labels }}
-{{ toYaml .Values.service.labels | indent 4 }}
-{{- end }}
-{{- $root := . }}
-{{- with .Values.service.annotations }}
+    {{- if .Values.service.labels }}
+    {{- toYaml . | nindent 4 }}
+    {{- end }}
+  {{- $root := . }}
+  {{- with .Values.service.annotations }}
   annotations:
-{{ tpl (toYaml . | indent 4) $root }}
-{{- end }}
+    {{- tpl (toYaml . | indent 4) $root }}
+  {{- end }}
 spec:
-{{- if (or (eq .Values.service.type "ClusterIP") (empty .Values.service.type)) }}
+  {{- if (or (eq .Values.service.type "ClusterIP") (empty .Values.service.type)) }}
   type: ClusterIP
-  {{- if .Values.service.clusterIP }}
-  clusterIP: {{ .Values.service.clusterIP }}
-  {{end}}
-{{- else if eq .Values.service.type "LoadBalancer" }}
+  {{- with .Values.service.clusterIP }}
+  clusterIP: {{ . }}
+  {{- end }}
+  {{- else if eq .Values.service.type "LoadBalancer" }}
   type: {{ .Values.service.type }}
-  {{- if .Values.service.loadBalancerIP }}
-  loadBalancerIP: {{ .Values.service.loadBalancerIP }}
+  {{- with .Values.service.loadBalancerIP }}
+  loadBalancerIP: {{ . }}
   {{- end }}
-  {{- if .Values.service.loadBalancerSourceRanges }}
+  {{- with .Values.service.loadBalancerSourceRanges }}
   loadBalancerSourceRanges:
-{{ toYaml .Values.service.loadBalancerSourceRanges | indent 4 }}
-  {{- end -}}
-{{- else }}
+    {{- toYaml . | nindent 4 }}
+  {{- end }}
+  {{- else }}
   type: {{ .Values.service.type }}
-{{- end }}
-{{- if .Values.service.externalIPs }}
+  {{- end }}
+  {{- with .Values.service.externalIPs }}
   externalIPs:
-{{ toYaml .Values.service.externalIPs | indent 4 }}
-{{- end }}
+    {{- toYaml . | nindent 4 }}
+  {{- end }}
   ports:
     - name: {{ .Values.service.portName }}
       port: {{ .Values.service.port }}
       protocol: TCP
       targetPort: {{ .Values.service.targetPort }}
-      {{- if .Values.service.appProtocol }}
-      appProtocol: {{ .Values.service.appProtocol }}
+      {{- with .Values.service.appProtocol }}
+      appProtocol: {{ . }}
       {{- end }}
       {{- if (and (eq .Values.service.type "NodePort") (not (empty .Values.service.nodePort))) }}
-      nodePort: {{.Values.service.nodePort}}
-      {{ end }}
+      nodePort: {{ .Values.service.nodePort }}
+      {{- end }}
       {{- if .Values.extraExposePorts }}
       {{- tpl (toYaml .Values.extraExposePorts) . | nindent 4 }}
       {{- end }}
diff --git a/charts/grafana/templates/serviceaccount.yaml b/charts/grafana/templates/serviceaccount.yaml
index 1a401fe4..bbfe4147 100644
--- a/charts/grafana/templates/serviceaccount.yaml
+++ b/charts/grafana/templates/serviceaccount.yaml
@@ -4,14 +4,14 @@ kind: ServiceAccount
 metadata:
   labels:
     {{- include "grafana.labels" . | nindent 4 }}
-  {{- with .Values.serviceAccount.labels }}
+    {{- with .Values.serviceAccount.labels }}
     {{- toYaml . | nindent 4 }}
-  {{- end }}
-{{- $root := . }}
-{{- with .Values.serviceAccount.annotations }}
+    {{- end }}
+  {{- $root := . }}
+  {{- with .Values.serviceAccount.annotations }}
   annotations:
-{{ tpl (toYaml . | indent 4) $root }}
-{{- end }}
-  name: {{ template "grafana.serviceAccountName" . }}
-  namespace: {{ template "grafana.namespace" . }}
-{{- end }}
+    {{- tpl (toYaml . | indent 4) $root }}
+  {{- end }}
+  name: {{ include "grafana.serviceAccountName" . }}
+  namespace: {{ include "grafana.namespace" . }}
+  {{- end }}
diff --git a/charts/grafana/templates/servicemonitor.yaml b/charts/grafana/templates/servicemonitor.yaml
index 0876a637..6575fb9a 100644
--- a/charts/grafana/templates/servicemonitor.yaml
+++ b/charts/grafana/templates/servicemonitor.yaml
@@ -3,16 +3,16 @@
 apiVersion: monitoring.coreos.com/v1
 kind: ServiceMonitor
 metadata:
-  name: {{ template "grafana.fullname" . }}
+  name: {{ include "grafana.fullname" . }}
   {{- if .Values.serviceMonitor.namespace }}
   namespace: {{ tpl .Values.serviceMonitor.namespace . }}
   {{- else }}
-  namespace: {{ template "grafana.namespace" . }}
+  namespace: {{ include "grafana.namespace" . }}
   {{- end }}
   labels:
     {{- include "grafana.labels" . | nindent 4 }}
-    {{- if .Values.serviceMonitor.labels }}
-    {{- toYaml .Values.serviceMonitor.labels | nindent 4 }}
+    {{- with .Values.serviceMonitor.labels }}
+    {{- toYaml . | nindent 4 }}
     {{- end }}
 spec:
   endpoints:
@@ -26,19 +26,19 @@ spec:
     honorLabels: true
     path: {{ .Values.serviceMonitor.path }}
     scheme: {{ .Values.serviceMonitor.scheme }}
-    {{- if .Values.serviceMonitor.tlsConfig }}
+    {{- with .Values.serviceMonitor.tlsConfig }}
     tlsConfig:
-    {{- toYaml .Values.serviceMonitor.tlsConfig | nindent 6 }}
+      {{- toYaml . | nindent 6 }}
     {{- end }}
-    {{- if .Values.serviceMonitor.relabelings }}
+    {{- with .Values.serviceMonitor.relabelings }}
     relabelings:
-    {{- toYaml .Values.serviceMonitor.relabelings | nindent 4 }}
+      {{- toYaml . | nindent 6 }}
     {{- end }}
   jobLabel: "{{ .Release.Name }}"
   selector:
     matchLabels:
-      {{- include "grafana.selectorLabels" . | nindent 8 }}
+      {{- include "grafana.selectorLabels" . | nindent 6 }}
   namespaceSelector:
     matchNames:
-      - {{ template "grafana.namespace" . }}
+      - {{ include "grafana.namespace" . }}
 {{- end }}
diff --git a/charts/grafana/templates/statefulset.yaml b/charts/grafana/templates/statefulset.yaml
index b308dec4..ca23b065 100644
--- a/charts/grafana/templates/statefulset.yaml
+++ b/charts/grafana/templates/statefulset.yaml
@@ -2,37 +2,37 @@
 apiVersion: apps/v1
 kind: StatefulSet
 metadata:
-  name: {{ template "grafana.fullname" . }}
-  namespace: {{ template "grafana.namespace" . }}
+  name: {{ include "grafana.fullname" . }}
+  namespace: {{ include "grafana.namespace" . }}
   labels:
     {{- include "grafana.labels" . | nindent 4 }}
-{{- with .Values.annotations }}
+  {{- with .Values.annotations }}
   annotations:
-{{ toYaml . | indent 4 }}
-{{- end }}
+    {{- toYaml . | nindent 4 }}
+  {{- end }}
 spec:
   replicas: {{ .Values.replicas }}
   selector:
     matchLabels:
       {{- include "grafana.selectorLabels" . | nindent 6 }}
-  serviceName: {{ template "grafana.fullname" . }}-headless
+  serviceName: {{ include "grafana.fullname" . }}-headless
   template:
     metadata:
       labels:
         {{- include "grafana.selectorLabels" . | nindent 8 }}
-{{- with .Values.podLabels }}
-{{ toYaml . | indent 8 }}
-{{- end }}
+        {{- with .Values.podLabels }}
+        {{- toYaml . | nindent 8 }}
+        {{- end }}
       annotations:
         checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
         checksum/dashboards-json-config: {{ include (print $.Template.BasePath "/dashboards-json-configmap.yaml") . | sha256sum }}
         checksum/sc-dashboard-provider-config: {{ include (print $.Template.BasePath "/configmap-dashboard-provider.yaml") . | sha256sum }}
-  {{- if and (or (and (not .Values.admin.existingSecret) (not .Values.env.GF_SECURITY_ADMIN_PASSWORD__FILE) (not .Values.env.GF_SECURITY_ADMIN_PASSWORD)) (and .Values.ldap.enabled (not .Values.ldap.existingSecret))) (not .Values.env.GF_SECURITY_DISABLE_INITIAL_ADMIN_CREATION) }}
+        {{- if and (or (and (not .Values.admin.existingSecret) (not .Values.env.GF_SECURITY_ADMIN_PASSWORD__FILE) (not .Values.env.GF_SECURITY_ADMIN_PASSWORD)) (and .Values.ldap.enabled (not .Values.ldap.existingSecret))) (not .Values.env.GF_SECURITY_DISABLE_INITIAL_ADMIN_CREATION) }}
         checksum/secret: {{ include (print $.Template.BasePath "/secret.yaml") . | sha256sum }}
-{{- end }}
-{{- with .Values.podAnnotations }}
-{{ toYaml . | indent 8 }}
-{{- end }}
+        {{- end }}
+        {{- with .Values.podAnnotations }}
+        {{- toYaml . | nindent 8 }}
+        {{- end }}
     spec:
       {{- include "grafana.pod" . | nindent 6 }}
   {{- if .Values.persistence.enabled}}
@@ -48,7 +48,7 @@ spec:
       {{- with .Values.persistence.selectorLabels }}
       selector:
         matchLabels:
-{{ toYaml . | indent 10 }}
+          {{- toYaml . | nindent 10 }}
       {{- end }}
   {{- end }}
 {{- end }}
